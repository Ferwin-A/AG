<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TUVN - Monitoreo Promedio</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Roboto', sans-serif; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen flex flex-col">

    <header class="bg-slate-800 text-white shadow-lg border-b-4 border-red-600">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tight">TUVN - Monitoreo Promedio</h1>
            <div class="flex items-center gap-3 bg-slate-700/50 px-4 py-2 rounded-lg border border-slate-500/30">
                <div class="relative flex h-3 w-3">
                    <span id="pingDot" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-300 opacity-75 hidden"></span>
                    <span id="staticDot" class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                </div>
                <span id="statusText" class="text-sm font-mono text-red-300">Desconectado</span>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-10">

        <h2 class="text-3xl font-bold mb-8 text-center text-white">Promedio de Temperatura</h2>

        <div class="grid place-items-center">

            <!-- PROMEDIO -->
            <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-xl p-10 text-center">
                <h3 class="text-emerald-400 font-bold mb-4">PROMEDIO</h3>
                <div id="promedio" class="text-6xl font-bold text-white">--</div>
                <p class="text-slate-400 mt-2 text-sm">Promedio General (°C)</p>
            </div>

            <!-- BOTÓN -->
            <div class="mt-12">
                <button id="connectBtn" onclick="toggleConnection()"
                    class="bg-red-700 hover:bg-red-600 text-white font-bold py-4 px-10 rounded-full shadow-lg flex items-center gap-3 transition-transform hover:scale-105 active:scale-95">
                    <i data-lucide="bluetooth" class="w-6 h-6"></i>
                    <span>CONECTAR DISPOSITIVO</span>
                </button>
            </div>
        </div>
    </main>

    <footer class="bg-slate-900 text-slate-500 py-6 text-center text-xs border-t-4 border-red-600">
        <p>©️ 2025 Instituto Superior Tecnológico Vida Nueva</p>
    </footer>

    <script>
        lucide.createIcons();

        // BLUETOOTH
        const serviceUuid = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const characteristicUuid = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        let bluetoothDevice;
        let bleCharacteristic;

        const connectBtn = document.getElementById('connectBtn');
        const statusText = document.getElementById('statusText');
        const pingDot = document.getElementById('pingDot');
        const staticDot = document.getElementById('staticDot');
        const promedioEl = document.getElementById('promedio');

        async function toggleConnection() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) disconnect();
            else connect();
        }

        async function connect() {
            try {
                connectBtn.innerHTML = '<span class="animate-spin">⌛</span> BUSCANDO...';

                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'TUVN_Termometros' }],
                    optionalServices: [serviceUuid]
                });

                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService(serviceUuid);
                bleCharacteristic = await service.getCharacteristic(characteristicUuid);

                await bleCharacteristic.startNotifications();
                bleCharacteristic.addEventListener('characteristicvaluechanged', handleData);

                updateUIConnected();

            } catch (error) {
                updateUIDisconnected();
            }
        }

        function disconnect() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
        }

        function onDisconnected() {
            updateUIDisconnected();
        }

        function handleData(event) {
            const decoder = new TextDecoder('utf-8');
            const jsonString = decoder.decode(event.target.value);
            try {
                const data = JSON.parse(jsonString);
                if (data.prom !== undefined) {
                    promedioEl.innerText = data.prom.toFixed(1);
                }
                pingDot.classList.remove('hidden');
                setTimeout(() => pingDot.classList.add('hidden'), 300);
            } catch (e) {
                console.error("JSON inválido:", e);
            }
        }

        function updateUIConnected() {
            connectBtn.innerHTML = 'DESCONECTAR';
            connectBtn.classList.replace('bg-red-700', 'bg-emerald-700');

            statusText.innerText = "CONECTADO";
            statusText.classList.replace('text-red-300', 'text-emerald-300');
            staticDot.classList.replace('bg-red-500', 'bg-emerald-400');
        }

        function updateUIDisconnected() {
            connectBtn.innerHTML = '<i data-lucide="bluetooth" class="w-6 h-6"></i> CONECTAR DISPOSITIVO';
            lucide.createIcons();
            connectBtn.classList.replace('bg-emerald-700', 'bg-red-700');

            statusText.innerText = "DESCONECTADO";
            statusText.classList.replace('text-emerald-300', 'text-red-300');
            staticDot.classList.replace('bg-emerald-400', 'bg-red-500');

            promedioEl.innerText = "--";
        }
    </script>
</body>
</html>
